steps:
- id: test
  name: "python:3.7"
  entrypoint: 'bash'
  args:
    - '-c'
    - |
      pip3 install -r ./app/requirements.txt
      python3 ./app/test.py ./app/

- id: build
  name: "gcr.io/cloud-builders/docker"
  args:
    - 'build'
    - '-t'
    - 'gcr.io/${PROJECT_ID}/gke-flask-app:${SHORT_SHA}'
    - './app'

- id: push
  name: "gcr.io/cloud-builders/docker"
  args:
    - 'push'
    - 'gcr.io/${PROJECT_ID}/gke-flask-app:${SHORT_SHA}'

- id: kustomize
  name: "gcr.io/${PROJECT_ID}/kustomize"
  entrypoint: bash
  args:
    - '-c'
    - |
      kustomize build "./overlays/prod" -o "/workspace/resources.yaml"
  env:
      - 'CLOUDSDK_COMPUTE_REGION=us-west1'
      - 'CLOUDSDK_CONTAINER_CLUSTER=oregon'
      - 'GCLOUD_PROJECT=agmsb-k8s'

- id: git-secrets
  name: gcr.io/cloud-builders/gcloud
  entrypoint: 'bash'
  args: [ '-c', 'gcloud secrets versions access latest --secret=github > /root/.ssh/id_github' ]
  volumes:
  - name: 'ssh'
    path: /root/.ssh

- id: git-configure
  name: 'gcr.io/cloud-builders/git'
  entrypoint: 'bash'
  args:
  - '-c'
  - |
    chmod 600 /root/.ssh/id_github
    cat <<EOF >/root/.ssh/config
    Hostname github.com
    IdentityFile /root/.ssh/id_github
    EOF
    ssh-keyscan -t rsa github.com > /root/.ssh/known_hosts
  volumes:
  - name: 'ssh'
    path: /root/.ssh

- id: git-update-env-repo
  name: 'gcr.io/cloud-builders/git'
  entrypoint: 'bash'
  args:
  - '-c'
  - |
    git config --global user.email "agmsbush@gmail.com"
    git config --global user.name "Cloud Build"
    git clone git@github.com:agmsbush/gke-dev-to-prod-env
    cd gke-dev-to-prod-env
    git checkout -b candidate-${SHORT_SHA}
    cp /workspace/resources.yaml /workspace/gke-dev-to-prod-env/resources.yaml
    git add .
    git commit -F- <<EOF
    This commit updates the gke-flask-app container image to:

        gcr.io/${PROJECT_ID}/pipeline:${SHORT_SHA}.

    Build ID: ${BUILD_ID}
    EOF 
    git push --set-upstream origin candidate-${SHORT_SHA}
  volumes:
  - name: 'ssh'
    path: /root/.ssh

# - id: gke-deploy-qa
#   name: "gcr.io/cloud-builders/gke-deploy"
#   args:
#     - 'run'
#     - '-f'
#     - '/workspace/resources.yaml'
#     - '--image=gcr.io/${PROJECT_ID}/gke-flask-app:${SHORT_SHA}'
#     - '--label=commit-sha=${SHORT_SHA}'
#     - '--location=us-west1'
#     - '--cluster=oregon'

# - id: github-auth
#   name: 'gcr.io/cloud-builders/gcloud'
#   entrypoint: 'sh'
#   args:
#     - '-c'
#     - |
#       gsutil cp gs://${PROJECT_ID}-gke-flask-app/hub.enc hub.enc
#       gcloud kms decrypt \
#         --ciphertext-file=hub.enc \
#         --plaintext-file=/config/hub \
#         --location=global \
#         --keyring=gke-flask-app \
#         --key=github
#   volumes:
#     - name: 'config'
#       path: /config

# - id: gke-flask-app-env
#   name: 'gcr.io/agmsb-k8s/hub'
#   env:
#     - 'HUB_CONFIG=/config/hub'
#   entrypoint: 'sh'
#   args:
#     - '-c'
#     - |
#       hub config --global credential.https://github.com.helper /usr/local/bin/hub-credential-helper
#       hub config --global hub.protocol https
#       hub config --global user.email "agmsbush@gmail.com"
#       hub config --global user.name "Cloud Build"
#       hub clone "https://github.com/agmsbush/gke-dev-to-prod-env.git"
#       cd gke-dev-to-prod-env

#       hub branch candidate-${SHORT_SHA}
#       hub checkout candidate-${SHORT_SHA}

#       cp /workspace/resources.yaml /workspace/gke-dev-to-prod-env/resources.yaml

#       hub add .

#       hub commit -F- <<EOF
#       This commit updates the gke-flask-app container image to:

#           gcr.io/${PROJECT_ID}/pipeline:${SHORT_SHA}.

#       Build ID: ${BUILD_ID}
#       EOF
      
#       hub push --set-upstream origin candidate-${SHORT_SHA}

#   volumes:
#     - name: 'config'
#       path: /config